<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Батарея от Встряхивания</title>
    <!-- Подключаем Tailwind CSS для стилизации -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden; /* Предотвращаем горизонтальный скролл */
            cursor: pointer; /* Показываем, что можно нажать */
        }

        /* Стили для иконки батареи */
        .battery-icon {
            /* Увеличенные размеры */
            width: 300px;
            height: 150px;
            border: 8px solid #ccc;
            border-radius: 20px;
            position: relative;
            background: #444; /* Фон пустой батареи */
        }
        .battery-icon::after {
            content: '';
            position: absolute;
            /* Скорректировано под новый размер */
            top: 45px; /* (150 - 60) / 2 */
            right: -23px; /* 15px width + 8px border */
            width: 15px;
            height: 60px;
            background: #ccc;
            border-radius: 5px;
        }
        .battery-fill {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, #22c55e, #22c55e); /* Зеленый цвет */
            border-radius: 12px; /* 20px radius - 8px border */
            transform-origin: left;
            transition: transform 0.3s ease-out; /* Плавное заполнение */
            transform: scaleX(0); /* Изначально пустая */
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Иконка батареи -->
    <div class="flex flex-col items-center justify-center my-8" id="batteryWrapper">
        <div class="battery-icon relative">
            <div class="battery-fill" id="batteryFill"></div>
        </div>
        <!-- Увеличенный текст процентов -->
        <p id="batteryLevelText" class="text-6xl font-bold mt-6">Нажмите</p>
    </div>

    <!-- Статус/Ошибка -->
    <p id="status" class="text-gray-500 mt-4 h-6 text-center"></p>

    <script>
        // Элементы DOM
        const statusEl = document.getElementById('status');
        const batteryWrapper = document.getElementById('batteryWrapper');
        const batteryFill = document.getElementById('batteryFill');
        const batteryLevelText = document.getElementById('batteryLevelText');

        let isStarted = false;
        let batteryLevel = 0; // Уровень заполнения батареи
        const MAX_BATTERY_LEVEL = 100;
        const SHAKE_THRESHOLD = 15; // Порог для определения встряхивания (значение ускорения)
        const FILL_AMOUNT_PER_SHAKE = 10; // На сколько процентов увеличивать при каждом встряхивании

        let lastX = 0, lastY = 0, lastZ = 0;
        let lastUpdate = 0;

        // Обработчик нажатия на экран (сработает один раз)
        document.body.addEventListener('click', async () => {
            if (isStarted) return; // Запускаем только один раз

            statusEl.textContent = 'Запрос доступа...';

            let permissionGranted = false;

            // --- Запрос DeviceMotionEvent для iOS 13+ (для акселерометра) ---
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                try {
                    const permissionState = await DeviceMotionEvent.requestPermission();
                    if (permissionState === 'granted') {
                        permissionGranted = true;
                        window.addEventListener('devicemotion', handleMotion);
                    }
                } catch (error) {
                    console.error("Ошибка запроса DeviceMotion:", error);
                    statusEl.textContent = 'Ошибка запроса DeviceMotion. (Нужен HTTPS)';
                }
            } else {
                // Android и другие браузеры - просто добавляем слушатель
                permissionGranted = true;
                window.addEventListener('devicemotion', handleMotion);
            }

            if (permissionGranted) {
                isStarted = true;
                statusEl.textContent = 'Встряхните телефон!';
                updateBatteryDisplay(); // Обновляем текст с "Нажмите" на "0%"
            } else {
                 statusEl.textContent = 'Доступ к сенсорам запрещен.';
                 batteryLevelText.textContent = 'Ошибка';
            }
        }, { once: true }); // { once: true } гарантирует, что этот слушатель сработает только один раз

        // Обновление отображения батареи
        function updateBatteryDisplay() {
            if (!isStarted) {
                batteryLevelText.textContent = 'Нажмите';
                return;
            }
            const fillPercentage = batteryLevel / MAX_BATTERY_LEVEL;
            batteryFill.style.transform = `scaleX(${fillPercentage})`;
            batteryLevelText.textContent = `${batteryLevel}%`;
        }

        // Обработчик данных с сенсора движения (акселерометр)
        function handleMotion(event) {
            const acceleration = event.accelerationIncludingGravity;

            if (acceleration && acceleration.x !== null && acceleration.y !== null && acceleration.z !== null) {
                const currentTime = Date.now();
                if (currentTime - lastUpdate > 100) { // Проверяем каждые 100 мс
                    const diffX = Math.abs(acceleration.x - lastX);
                    const diffY = Math.abs(acceleration.y - lastY);
                    const diffZ = Math.abs(acceleration.z - lastZ);

                    // Если любое из изменений превышает порог, считаем это "встряхиванием"
                    if (diffX > SHAKE_THRESHOLD || diffY > SHAKE_THRESHOLD || diffZ > SHAKE_THRESHOLD) {
                        batteryLevel = Math.min(MAX_BATTERY_LEVEL, batteryLevel + FILL_AMOUNT_PER_SHAKE);
                        updateBatteryDisplay();
                    }

                    lastX = acceleration.x;
                    lastY = acceleration.y;
                    lastZ = acceleration.z;
                    lastUpdate = currentTime;
                }
            }
        }

        // Инициализация
        if (!window.DeviceMotionEvent) {
            statusEl.textContent = 'Ваше устройство не поддерживает сенсоры движения.';
            batteryLevelText.textContent = 'N/A';
            document.body.style.cursor = 'default'; // Убираем курсор
        }

        updateBatteryDisplay(); // Изначально показываем "Нажмите"
    </script>
</body>
</html>

